<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Dinámico de Intercambios (v9 - Filtro)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet-groupedlayercontrol@0.6.1/dist/leaflet.groupedlayercontrol.min.css"/>
    <script src="https://unpkg.com/leaflet-groupedlayercontrol@0.6.1/dist/leaflet.groupedlayercontrol.min.js"></script>
    
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        
        /* --- ESTILOS DE LEYENDA INTERACTIVA --- */
        .info.legend {
            padding: 8px; font: 14px Arial, sans-serif;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px;
            line-height: 24px; color: #333;
            max-width: 250px;
        }
        .legend-item a {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
            text-decoration: none;
            color: #333;
            cursor: pointer;
        }
        .legend-item i {
            width: 30px;
            height: 0px; 
            margin-right: 8px;
            opacity: 0.85;
            border-style: solid;
            transition: opacity 0.2s;
        }
        /* Estilo 'apagado' para la leyenda */
        .legend-item a.off {
            color: #999;
            text-decoration: line-through;
        }
        .legend-item a.off i {
            opacity: 0.2;
        }
        
        /* --- CSS PARA EL SCROLL DEL CONTROL DE CAPAS --- */
        .leaflet-control-layers-expanded {
            max-height: 80vh; 
            overflow-y: auto; 
        }
    </style>
    
    <script src="Capas Base/334/334_AGS ORIGEN.js"></script>
    <script src="Capas Base/334/334_BC ORIGEN.js"></script>
    <script src="Capas Base/334/334_COAH ORIGEN.js"></script>
    <script src="Capas Base/334/334_GTO ORIGEN.js"></script>
    <script src="Capas Base/334/334_JAL ORIGEN.js"></script>
    <script src="Capas Base/334/334_MEX ORIGEN.js"></script>
    <script src="Capas Base/334/334_MOR ORIGEN.js"></script>
    <script src="Capas Base/334/334_NL ORIGEN.js"></script>
    <script src="Capas Base/334/334_PUE ORIGEN.js"></script>
    <script src="Capas Base/334/334_SLP ORIGEN.js"></script>
    <script src="Capas Base/335/335_AGS ORIGEN.js"></script>
    <script src="Capas Base/335/335_BC ORIGEN.js"></script>
    <script src="Capas Base/335/335_COAH ORIGEN.js"></script>
    <script src="Capas Base/335/335_GTO ORIGEN.js"></script>
    <script src="Capas Base/335/335_JAL ORIGEN.js"></script>
    <script src="Capas Base/335/335_MEX ORIGEN.js"></script>
    <script src="Capas Base/335/335_MOR ORIGEN.js"></script>
    <script src="Capas Base/335/335_NL ORIGEN.js"></script>
    <script src="Capas Base/335/335_PUE ORIGEN.js"></script>
    <script src="Capas Base/335/335_SLP ORIGEN.js"></script>
    <script src="Capas Base/511/511_AGS ORIGEN.js"></script>
    <script src="Capas Base/511/511_BC ORIGEN.js"></script>
    <script src="Capas Base/511/511_COAH ORIGEN.js"></script>
    <script src="Capas Base/511/511_GTO ORIGEN.js"></script>
    <script src="Capas Base/511/511_JAL ORIGEN.js"></script>
    <script src="Capas Base/511/511_MEX ORIGEN.js"></script>
    <script src="Capas Base/511/511_MOL ORIGEN.js"></script>
    <script src="Capas Base/511/511_NL ORIGEN.js"></script>
    <script src="Capas Base/511/511_PUE ORIGEN.js"></script>
    <script src="Capas Base/511/511_SLP ORIGEN.js"></script>
    <script src="Capas Base/512/512_AGS ORIGEN.js"></script>
    <script src="Capas Base/512/512_BC ORIGEN.js"></script>
    <script src="Capas Base/512/512_COAH ORIGEN.js"></script>
    <script src="Capas Base/512/512_GTO ORIGEN.js"></script>
    <script src="Capas Base/512/512_JAL ORIGEN.js"></script>
    <script src="Capas Base/512/512_MEX ORIGEN.js"></script>
    <script src="Capas Base/512/512_MOR ORIGEN.js"></script>
    <script src="Capas Base/512/512_NL ORIGEN.js"></script>
    <script src="Capas Base/512/512_PUE ORIGEN.js"></script>
    <script src="Capas Base/512/512_SLP ORIGEN.js"></script>
    <script src="Capas Base/515/515_AGS ORIGEN.js"></script>
    <script src="Capas Base/515/515_BC ORIGEN.js"></script>
    <script src="Capas Base/515/515_COAH ORIGEN.js"></script>
    <script src="Capas Base/515/515_GTO ORIGEN.js"></script>
    <script src="Capas Base/515/515_JAL ORIGEN.js"></script>
    <script src="Capas Base/515/515_MEX ORIGEN.js"></script>
    <script src="Capas Base/515/515_MOR ORIGEN.js"></script>
    <script src="Capas Base/515/515_NL ORIGEN.js"></script>
    <script src="Capas Base/515/515_PUE ORIGEN.js"></script>
    <script src="Capas Base/515/515_SLP ORIGEN.js"></script>
    <script src="Capas Base/517/517_AGS ORIGEN.js"></script>
    <script src="Capas Base/517/517_BC ORIGEN.js"></script>
    <script src="Capas Base/517/517_COAH ORIGEN.js"></script>
    <script src="Capas Base/517/517_GTO ORIGEN.js"></script>
    <script src="Capas Base/517/517_JAL ORIGEN.js"></script>
    <script src="Capas Base/517/517_MEX ORIGEN.js"></script>
    <script src="Capas Base/517/517_MOR ORIGEN.js"></script>
    <script src="Capas Base/517/517_NL ORIGEN.js"></script>
    <script src="Capas Base/517/517_PUE ORIGEN.js"></script>
    <script src="Capas Base/517/517_SLP ORIGEN.js"></script>
    <script src="Capas Base/518/518_AGS ORIGEN.js"></script>
    <script src="Capas Base/518/518_BC ORIGEN.js"></script>
    <script src="Capas Base/518/518_COAH ORIGEN.js"></script>
    <script src="Capas Base/518/518_GTO ORIGEN.js"></script>
    <script src="Capas Base/518/518_JAL ORIGEN.js"></script>
    <script src="Capas Base/518/518_MEX ORIGEN.js"></script>
    <script src="Capas Base/518/518_MOR ORIGEN.js"></script>
    <script src="Capas Base/518/518_NL ORIGEN.js"></script>
    <script src="Capas Base/518/518_PUE ORIGEN.js"></script>
    <script src="Capas Base/518/518_SLP ORIGEN.js"></script>
    <script src="Capas Base/519/519_AGS ORIGEN.js"></script>
    <script src="Capas Base/519/519_BC ORIGEN.js"></script>
    <script src="Capas Base/519/519_COAH ORIGEN.js"></script>
    <script src="Capas Base/519/519_GTO ORIGEN.js"></script>
    <script src="Capas Base/519/519_JAL ORIGEN.js"></script>
    <script src="Capas Base/519/519_MEX ORIGEN.js"></script>
    <script src="Capas Base/519/519_MOR ORIGEN.js"></script>
    <script src="Capas Base/519/519_NL ORIGEN.js"></script>
    <script src="Capas Base/519/519_PUE ORIGEN.js"></script>
    <script src="Capas Base/519/519_SLP ORIGEN.js"></script>
    <script src="Capas Base/541/541_AGS ORIGEN.js"></script>
    <script src="Capas Base/541/541_BC ORIGEN.js"></script>
    <script src="Capas Base/541/541_COAH ORIGEN.js"></script>
    <script src="Capas Base/541/541_GTO ORIGEN.js"></script>
    <script src="Capas Base/541/541_JAL ORIGEN.js"></script>
    <script src="Capas Base/541/541_MEX ORIGEN.js"></script>
    <script src="Capas Base/541/541_MOR ORIGEN.js"></script>
    <script src="Capas Base/541/541_NL ORIGEN.js"></script>
    <script src="Capas Base/541/541_PUE ORIGEN.js"></script>
    <script src="Capas Base/541/541_SLP ORIGEN.js"></script>
    
</head>
<body>
    
    <div id="map"></div>

    <script>
        // 1. Inicializar el mapa
        var map = L.map('map').setView([23.6, -102.5], 5);

        // 2. Mapas base
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        var esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        // --- INICIO DE NUEVA LÓGICA DE ESTILO (v9) ---
        
        const RampaRojos = ['#fee5d9','#fcae91','#fb6a4a','#de2d26','#a50f15'];
        const Grosores = [0.1, 0.5, 1.0, 1.5, 2.0];
        
        // --- Variables Globales de Filtrado ---
        // Rastrea qué clases están encendidas (true) o apagadas (false)
        var classFilterState = [true, true, true, true, true]; 
        // Rastrea qué capa (grupo) está actualmente activa en el mapa
        var activeLayerGroup = null; 

        // Leyenda (Posición: 'bottomleft')
        var legend = L.control({position: 'bottomleft'}); 
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = '<h4>Valor de Intercambio</h4><div id="legend-content">Seleccione una capa</div>';
            return div;
        };
        legend.addTo(map);

        // --- Funciones de estilo (AHORA GLOBALES) ---
        function getClase(valor, breaks) {
            if (!breaks || breaks.length < 5) return 0;
            if (valor <= breaks[0]) return 0;
            if (valor <= breaks[1]) return 1;
            if (valor <= breaks[2]) return 2;
            if (valor <= breaks[3]) return 3;
            return 4;
        }

        function getStyleForClase(clase) {
            return {
                color: RampaRojos[clase],    
                weight: Grosores[clase],   
                opacity: 0.85
            };
        }

        // Función para actualizar la leyenda (AHORA CREA LINKS)
        function actualizarLeyenda(breaks) {
            var div = document.getElementById('legend-content');
            if (!div || !breaks || breaks.length < 5) { 
                div.innerHTML = 'Seleccione una capa o datos insuficientes.';
                return;
            }
            
            var labels = [];
            // Genera 5 items de leyenda como links <a> con un atributo data-clase
            labels.push('<div class="legend-item"><a href="#" data-clase="0"><i style="border-color:'+RampaRojos[0]+'; border-width:'+Grosores[0]*2+'px;"></i> &le; '+breaks[0].toLocaleString('es-MX')+'</a></div>');
            labels.push('<div class="legend-item"><a href="#" data-clase="1"><i style="border-color:'+RampaRojos[1]+'; border-width:'+Grosores[1]*2+'px;"></i> '+breaks[0].toLocaleString('es-MX')+' &ndash; '+breaks[1].toLocaleString('es-MX')+'</a></div>');
            labels.push('<div class="legend-item"><a href="#" data-clase="2"><i style="border-color:'+RampaRojos[2]+'; border-width:'+Grosores[2]*2+'px;"></i> '+breaks[1].toLocaleString('es-MX')+' &ndash; '+breaks[2].toLocaleString('es-MX')+'</a></div>');
            labels.push('<div class="legend-item"><a href="#" data-clase="3"><i style="border-color:'+RampaRojos[3]+'; border-width:'+Grosores[3]*2+'px;"></i> '+breaks[2].toLocaleString('es-MX')+' &ndash; '+breaks[3].toLocaleString('es-MX')+'</a></div>');
            labels.push('<div class="legend-item"><a href="#" data-clase="4"><i style="border-color:'+RampaRojos[4]+'; border-width:'+Grosores[4]*2+'px;"></i> &gt; '+breaks[3].toLocaleString('es-MX')+'</a></div>');
            
            div.innerHTML = labels.join('');
            
            // Aplicar el estado de filtro actual a la leyenda recién creada
            classFilterState.forEach((is_on, index) => {
                var link = div.querySelector('a[data-clase="' + index + '"]');
                if (link) {
                    link.classList.toggle('off', !is_on);
                }
            });
        }

        // --- NUEVA Función de Filtrado ---
        // Se llama cuando haces clic en la leyenda
        function filtrarCapaActiva() {
            if (!activeLayerGroup) return; // No hay capa activa, no hacer nada

            var lines = activeLayerGroup.lines;
            var arrows = activeLayerGroup.decorators;
            var breaks = activeLayerGroup.styleBreaks;

            for (let i = 0; i < lines.length; i++) {
                var line = lines[i];
                var arrow = arrows[i];
                var valor = line.feature.properties.VALOR || line.feature.properties.Valor;
                var clase = getClase(valor, breaks);

                // Comprobar el estado del filtro para esta clase
                if (classFilterState[clase] === false) {
                    // Apagado: ocultar línea y quitar flecha del mapa
                    line.setStyle({ opacity: 0, fillOpacity: 0 });
                    if (map.hasLayer(arrow)) {
                        map.removeLayer(arrow);
                    }
                } else {
                    // Encendido: mostrar línea y añadir flecha al mapa
                    line.setStyle(getStyleForClase(clase));
                    if (!map.hasLayer(arrow)) {
                        map.addLayer(arrow);
                    }
                }
            }
        }

        // --- NUEVO Event Listener para la Leyenda ---
        legend.getContainer().addEventListener('click', function(e) {
            var link = e.target.closest('a[data-clase]');
            if (link) {
                e.preventDefault(); // Evitar que el link '#' mueva la página
                
                var claseIndex = parseInt(link.dataset.clase, 10);
                
                // 1. Cambiar el estado del filtro
                classFilterState[claseIndex] = !classFilterState[claseIndex];
                
                // 2. Actualizar el estilo del link (tachado/normal)
                link.classList.toggle('off', !classFilterState[claseIndex]);
                
                // 3. Aplicar el filtro a la capa que esté activa
                filtrarCapaActiva();
            }
        });


        // --- Fábrica de Capas Dinámicas (v9) ---
        function crearCapaDinamica(geojsonData, layerDisplayName) {
            
            // 1. Calcular 5 Clases
            const valores = geojsonData.features
                .map(f => f.properties.VALOR || f.properties.Valor) 
                .filter(v => v != null)
                .sort((a, b) => a - b);
            
            var breaks = [1, 10, 100, 1000, 10000]; 
            if (valores.length > 0) {
                const n = valores.length;
                const minVal = valores[0];
                const maxVal = valores[n - 1];
                let tempBreaks = [
                    valores[Math.floor(n * 0.2)], valores[Math.floor(n * 0.4)],
                    valores[Math.floor(n * 0.6)], valores[Math.floor(n * 0.8)],
                    maxVal
                ];
                let uniqueBreaks = [...new Set(tempBreaks)];
                if (uniqueBreaks.length < 5 || minVal === maxVal) {
                    const step = (maxVal - minVal) / 5;
                    if (step === 0) { breaks = [maxVal, maxVal, maxVal, maxVal, maxVal]; } 
                    else {
                        breaks = [
                            minVal + step, minVal + step * 2, minVal + step * 3,
                            minVal + step * 4, maxVal
                        ].map(b => parseFloat(b.toFixed(2)));
                    }
                } else { breaks = tempBreaks; }
            }

            // 2. Funciones de estilo y popup
            function styleFunction(feature) {
                const valor = feature.properties.VALOR || feature.properties.Valor;
                const clase = getClase(valor, breaks);
                return getStyleForClase(clase);
            }
            
            function onEachFeatureFunction(feature, layer) {
                var valorNum = feature.properties.VALOR || feature.properties.Valor;
                var valorFmt = valorNum ? valorNum.toLocaleString('es-MX') : 'No disponible';
                var edoV = feature.properties.Edo_V || feature.properties.EDO_V || 'N/A';
                layer.bindPopup(
                    '<b>' + layerDisplayName + '</b><br>' +
                    'Origen: <b>' + edoV + '</b><br>' +
                    'Valor: <b>' + valorFmt + '</b>'
                );
            }
            
            // 3. Crear la capa Leaflet (líneas)
            var geojsonLayer = L.geoJSON(geojsonData, {
                style: styleFunction,
                onEachFeature: onEachFeatureFunction
            });
            
            // 4. CREAR LAS FLECHAS
            var decorators = [];
            geojsonLayer.eachLayer(function(lineLayer) {
                var valor = lineLayer.feature.properties.VALOR || lineLayer.feature.properties.Valor;
                var clase = getClase(valor, breaks);
                var style = getStyleForClase(clase);
                
                var arrow = L.polylineDecorator(lineLayer, {
                    patterns: [
                        {
                            offset: '100%', 
                            symbol: L.Symbol.arrowHead({
                                pixelSize: 8 + (style.weight * 3), 
                                polygon: true,
                                pathOptions: {
                                    stroke: false, 
                                    color: style.color,    
                                    fillOpacity: style.opacity
                                }
                            })
                        }
                    ]
                });
                decorators.push(arrow);
            });
            
            // 5. Crear un FeatureGroup que contenga SÓLO las LÍNEAS
            var finalLayerGroup = L.featureGroup([geojsonLayer]);
            
            // 6. Guardar los breaks, líneas y flechas en el GRUPO
            finalLayerGroup.styleBreaks = breaks; 
            finalLayerGroup.lines = geojsonLayer.getLayers();
            finalLayerGroup.decorators = decorators;
            
            // 7. Añadir listener para la leyenda
            finalLayerGroup.on('add', function () {
                // Poner esta capa como la 'activa'
                activeLayerGroup = this;
                // Actualizar la leyenda
                actualizarLeyenda(this.styleBreaks);
                // Aplicar el filtro actual (en caso de que el usuario ya haya apagado clases)
                filtrarCapaActiva();
            });
            
            finalLayerGroup.on('remove', function() {
                // Quitar esta capa como 'activa'
                if (activeLayerGroup === this) {
                    activeLayerGroup = null;
                }
                // Limpiar la leyenda
                document.getElementById('legend-content').innerHTML = 'Seleccione una capa';
                // Quitar todas las flechas del mapa
                this.decorators.forEach(function(decorator) {
                    map.removeLayer(decorator);
                });
            });
            
            // 8. Devolver el grupo
            return finalLayerGroup;
        }
        // --- FIN DE NUEVA LÓGICA DE ESTILO ---

        /* ====================================================================
        CAMBIO 2: 
        El script de Python creó variables que empiezan con guion bajo
        (ej. _334_AGS_ORIGEN) porque no pueden empezar con número.
        El código HTML original buscaba "data_334_AGS_ORIGEN".
        Se corrigieron todas las llamadas para usar el nombre de 
        variable correcto (ej. _334_AGS_ORIGEN).
        ====================================================================
        */
        var layer_data_334_AGS_ORIGEN = crearCapaDinamica(_334_AGS_ORIGEN, 'AGS ORIGEN (Sector 334)');
        var layer_data_334_BC_ORIGEN = crearCapaDinamica(_334_BC_ORIGEN, 'BC ORIGEN (Sector 334)');
        var layer_data_334_COAH_ORIGEN = crearCapaDinamica(_334_COAH_ORIGEN, 'COAH ORIGEN (Sector 334)');
        var layer_data_334_GTO_ORIGEN = crearCapaDinamica(_334_GTO_ORIGEN, 'GTO ORIGEN (Sector 334)');
        var layer_data_334_JAL_ORIGEN = crearCapaDinamica(_334_JAL_ORIGEN, 'JAL ORIGEN (Sector 334)');
        var layer_data_334_MEX_ORIGEN = crearCapaDinamica(_334_MEX_ORIGEN, 'MEX ORIGEN (Sector 334)');
        var layer_data_334_MOR_ORIGEN = crearCapaDinamica(_334_MOR_ORIGEN, 'MOR ORIGEN (Sector 334)');
        var layer_data_334_NL_ORIGEN = crearCapaDinamica(_334_NL_ORIGEN, 'NL ORIGEN (Sector 334)');
        var layer_data_334_PUE_ORIGEN = crearCapaDinamica(_334_PUE_ORIGEN, 'PUE ORIGEN (Sector 334)');
        var layer_data_334_SLP_ORIGEN = crearCapaDinamica(_334_SLP_ORIGEN, 'SLP ORIGEN (Sector 334)');
        var layer_data_335_AGS_ORIGEN = crearCapaDinamica(_335_AGS_ORIGEN, 'AGS ORIGEN (Sector 335)');
        var layer_data_335_BC_ORIGEN = crearCapaDinamica(_335_BC_ORIGEN, 'BC ORIGEN (Sector 335)');
        var layer_data_335_COAH_ORIGEN = crearCapaDinamica(_335_COAH_ORIGEN, 'COAH ORIGEN (Sector 335)');
        var layer_data_335_GTO_ORIGEN = crearCapaDinamica(_335_GTO_ORIGEN, 'GTO ORIGEN (Sector 335)');
        var layer_data_335_JAL_ORIGEN = crearCapaDinamica(_335_JAL_ORIGEN, 'JAL ORIGEN (Sector 335)');
        var layer_data_335_MEX_ORIGEN = crearCapaDinamica(_335_MEX_ORIGEN, 'MEX ORIGEN (Sector 335)');
        var layer_data_335_MOR_ORIGEN = crearCapaDinamica(_335_MOR_ORIGEN, 'MOR ORIGEN (Sector 335)');
        var layer_data_335_NL_ORIGEN = crearCapaDinamica(_335_NL_ORIGEN, 'NL ORIGEN (Sector 335)');
        var layer_data_335_PUE_ORIGEN = crearCapaDinamica(_335_PUE_ORIGEN, 'PUE ORIGEN (Sector 335)');
        var layer_data_335_SLP_ORIGEN = crearCapaDinamica(_335_SLP_ORIGEN, 'SLP ORIGEN (Sector 335)');
        var layer_data_511_AGS_ORIGEN = crearCapaDinamica(_511_AGS_ORIGEN, 'AGS ORIGEN (Sector 511)');
        var layer_data_511_BC_ORIGEN = crearCapaDinamica(_511_BC_ORIGEN, 'BC ORIGEN (Sector 511)');
        var layer_data_511_COAH_ORIGEN = crearCapaDinamica(_511_COAH_ORIGEN, 'COAH ORIGEN (Sector 511)');
        var layer_data_511_GTO_ORIGEN = crearCapaDinamica(_511_GTO_ORIGEN, 'GTO ORIGEN (Sector 511)');
        var layer_data_511_JAL_ORIGEN = crearCapaDinamica(_511_JAL_ORIGEN, 'JAL ORIGEN (Sector 511)');
        var layer_data_511_MEX_ORIGEN = crearCapaDinamica(_511_MEX_ORIGEN, 'MEX ORIGEN (Sector 511)');
        var layer_data_511_MOL_ORIGEN = crearCapaDinamica(_511_MOL_ORIGEN, 'MOL ORIGEN (Sector 511)');
        var layer_data_511_NL_ORIGEN = crearCapaDinamica(_511_NL_ORIGEN, 'NL ORIGEN (Sector 511)');
        var layer_data_511_PUE_ORIGEN = crearCapaDinamica(_511_PUE_ORIGEN, 'PUE ORIGEN (Sector 511)');
        var layer_data_511_SLP_ORIGEN = crearCapaDinamica(_511_SLP_ORIGEN, 'SLP ORIGEN (Sector 511)');
        var layer_data_512_AGS_ORIGEN = crearCapaDinamica(_512_AGS_ORIGEN, 'AGS ORIGEN (Sector 512)');
        var layer_data_512_BC_ORIGEN = crearCapaDinamica(_512_BC_ORIGEN, 'BC ORIGEN (Sector 512)');
        var layer_data_512_COAH_ORIGEN = crearCapaDinamica(_512_COAH_ORIGEN, 'COAH ORIGEN (Sector 512)');
        var layer_data_512_GTO_ORIGEN = crearCapaDinamica(_512_GTO_ORIGEN, 'GTO ORIGEN (Sector 512)');
        var layer_data_512_JAL_ORIGEN = crearCapaDinamica(_512_JAL_ORIGEN, 'JAL ORIGEN (Sector 512)');
        var layer_data_512_MEX_ORIGEN = crearCapaDinamica(_512_MEX_ORIGEN, 'MEX ORIGEN (Sector 512)');
        var layer_data_512_MOR_ORIGEN = crearCapaDinamica(_512_MOR_ORIGEN, 'MOR ORIGEN (Sector 512)');
        var layer_data_512_NL_ORIGEN = crearCapaDinamica(_512_NL_ORIGEN, 'NL ORIGEN (Sector 512)');
        var layer_data_512_PUE_ORIGEN = crearCapaDinamica(_512_PUE_ORIGEN, 'PUE ORIGEN (Sector 512)');
        var layer_data_512_SLP_ORIGEN = crearCapaDinamica(_512_SLP_ORIGEN, 'SLP ORIGEN (Sector 512)');
        var layer_data_515_AGS_ORIGEN = crearCapaDinamica(_515_AGS_ORIGEN, 'AGS ORIGEN (Sector 515)');
        var layer_data_515_BC_ORIGEN = crearCapaDinamica(_515_BC_ORIGEN, 'BC ORIGEN (Sector 515)');
        var layer_data_515_COAH_ORIGEN = crearCapaDinamica(_515_COAH_ORIGEN, 'COAH ORIGEN (Sector 515)');
        var layer_data_515_GTO_ORIGEN = crearCapaDinamica(_515_GTO_ORIGEN, 'GTO ORIGEN (Sector 515)');
        var layer_data_515_JAL_ORIGEN = crearCapaDinamica(_515_JAL_ORIGEN, 'JAL ORIGEN (Sector 515)');
        var layer_data_515_MEX_ORIGEN = crearCapaDinamica(_515_MEX_ORIGEN, 'MEX ORIGEN (Sector 515)');
        var layer_data_515_MOR_ORIGEN = crearCapaDinamica(_515_MOR_ORIGEN, 'MOR ORIGEN (Sector 515)');
        var layer_data_515_NL_ORIGEN = crearCapaDinamica(_515_NL_ORIGEN, 'NL ORIGEN (Sector 515)');
        var layer_data_515_PUE_ORIGEN = crearCapaDinamica(_515_PUE_ORIGEN, 'PUE ORIGEN (Sector 515)');
        var layer_data_515_SLP_ORIGEN = crearCapaDinamica(_515_SLP_ORIGEN, 'SLP ORIGEN (Sector 515)');
        var layer_data_517_AGS_ORIGEN = crearCapaDinamica(_517_AGS_ORIGEN, 'AGS ORIGEN (Sector 517)');
        var layer_data_517_BC_ORIGEN = crearCapaDinamica(_517_BC_ORIGEN, 'BC ORIGEN (Sector 517)');
        var layer_data_517_COAH_ORIGEN = crearCapaDinamica(_517_COAH_ORIGEN, 'COAH ORIGEN (Sector 517)');
        var layer_data_517_GTO_ORIGEN = crearCapaDinamica(_517_GTO_ORIGEN, 'GTO ORIGEN (Sector 517)');
        var layer_data_517_JAL_ORIGEN = crearCapaDinamica(_517_JAL_ORIGEN, 'JAL ORIGEN (Sector 517)');
        var layer_data_517_MEX_ORIGEN = crearCapaDinamica(_517_MEX_ORIGEN, 'MEX ORIGEN (Sector 517)');
        var layer_data_517_MOR_ORIGEN = crearCapaDinamica(_517_MOR_ORIGEN, 'MOR ORIGEN (Sector 517)');
        var layer_data_517_NL_ORIGEN = crearCapaDinamica(_517_NL_ORIGEN, 'NL ORIGEN (Sector 517)');
        var layer_data_517_PUE_ORIGEN = crearCapaDinamica(_517_PUE_ORIGEN, 'PUE ORIGEN (Sector 517)');
        var layer_data_517_SLP_ORIGEN = crearCapaDinamica(_517_SLP_ORIGEN, 'SLP ORIGEN (Sector 517)');
        var layer_data_518_AGS_ORIGEN = crearCapaDinamica(_518_AGS_ORIGEN, 'AGS ORIGEN (Sector 518)');
        var layer_data_518_BC_ORIGEN = crearCapaDinamica(_518_BC_ORIGEN, 'BC ORIGEN (Sector 518)');
        var layer_data_518_COAH_ORIGEN = crearCapaDinamica(_518_COAH_ORIGEN, 'COAH ORIGEN (Sector 518)');
        var layer_data_518_GTO_ORIGEN = crearCapaDinamica(_518_GTO_ORIGEN, 'GTO ORIGEN (Sector 518)');
        var layer_data_518_JAL_ORIGEN = crearCapaDinamica(_518_JAL_ORIGEN, 'JAL ORIGEN (Sector 518)');
        var layer_data_518_MEX_ORIGEN = crearCapaDinamica(_518_MEX_ORIGEN, 'MEX ORIGEN (Sector 518)');
        var layer_data_518_MOR_ORIGEN = crearCapaDinamica(_518_MOR_ORIGEN, 'MOR ORIGEN (Sector 518)');
        var layer_data_518_NL_ORIGEN = crearCapaDinamica(_518_NL_ORIGEN, 'NL ORIGEN (Sector 518)');
        var layer_data_518_PUE_ORIGEN = crearCapaDinamica(_518_PUE_ORIGEN, 'PUE ORIGEN (Sector 518)');
        var layer_data_518_SLP_ORIGEN = crearCapaDinamica(_518_SLP_ORIGEN, 'SLP ORIGEN (Sector 518)');
        var layer_data_519_AGS_ORIGEN = crearCapaDinamica(_519_AGS_ORIGEN, 'AGS ORIGEN (Sector 519)');
        var layer_data_519_BC_ORIGEN = crearCapaDinamica(_519_BC_ORIGEN, 'BC ORIGEN (Sector 519)');
        var layer_data_519_COAH_ORIGEN = crearCapaDinamica(_519_COAH_ORIGEN, 'COAH ORIGEN (Sector 519)');
        var layer_data_519_GTO_ORIGEN = crearCapaDinamica(_519_GTO_ORIGEN, 'GTO ORIGEN (Sector 519)');
        var layer_data_519_JAL_ORIGEN = crearCapaDinamica(_519_JAL_ORIGEN, 'JAL ORIGEN (Sector 519)');
        var layer_data_519_MEX_ORIGEN = crearCapaDinamica(_519_MEX_ORIGEN, 'MEX ORIGEN (Sector 519)');
        var layer_data_519_MOR_ORIGEN = crearCapaDinamica(_519_MOR_ORIGEN, 'MOR ORIGEN (Sector 519)');
        var layer_data_519_NL_ORIGEN = crearCapaDinamica(_519_NL_ORIGEN, 'NL ORIGEN (Sector 519)');
        var layer_data_519_PUE_ORIGEN = crearCapaDinamica(_519_PUE_ORIGEN, 'PUE ORIGEN (Sector 519)');
        var layer_data_519_SLP_ORIGEN = crearCapaDinamica(_519_SLP_ORIGEN, 'SLP ORIGEN (Sector 519)');
        var layer_data_541_AGS_ORIGEN = crearCapaDinamica(_541_AGS_ORIGEN, 'AGS ORIGEN (Sector 541)');
        var layer_data_541_BC_ORIGEN = crearCapaDinamica(_541_BC_ORIGEN, 'BC ORIGEN (Sector 541)');
        var layer_data_541_COAH_ORIGEN = crearCapaDinamica(_541_COAH_ORIGEN, 'COAH ORIGEN (Sector 541)');
        var layer_data_541_GTO_ORIGEN = crearCapaDinamica(_541_GTO_ORIGEN, 'GTO ORIGEN (Sector 541)');
        var layer_data_541_JAL_ORIGEN = crearCapaDinamica(_541_JAL_ORIGEN, 'JAL ORIGEN (Sector 541)');
        var layer_data_541_MEX_ORIGEN = crearCapaDinamica(_541_MEX_ORIGEN, 'MEX ORIGEN (Sector 541)');
        var layer_data_541_MOR_ORIGEN = crearCapaDinamica(_541_MOR_ORIGEN, 'MOR ORIGEN (Sector 541)');
        var layer_data_541_NL_ORIGEN = crearCapaDinamica(_541_NL_ORIGEN, 'NL ORIGEN (Sector 541)');
        var layer_data_541_PUE_ORIGEN = crearCapaDinamica(_541_PUE_ORIGEN, 'PUE ORIGEN (Sector 541)');
        var layer_data_541_SLP_ORIGEN = crearCapaDinamica(_541_SLP_ORIGEN, 'SLP ORIGEN (Sector 541)');

        // 4. Definir los grupos de capas para el control
        var baseMaps = {
            "OpenStreetMap": osm,
            "Satélite Esri": esriSat
        };
        var groupedOverlays = {
        "Subsector 334": {
            "AGS ORIGEN": layer_data_334_AGS_ORIGEN,
            "BC ORIGEN": layer_data_334_BC_ORIGEN,
            "COAH ORIGEN": layer_data_334_COAH_ORIGEN,
            "GTO ORIGEN": layer_data_334_GTO_ORIGEN,
            "JAL ORIGEN": layer_data_334_JAL_ORIGEN,
            "MEX ORIGEN": layer_data_334_MEX_ORIGEN,
            "MOR ORIGEN": layer_data_334_MOR_ORIGEN,
            "NL ORIGEN": layer_data_334_NL_ORIGEN,
            "PUE ORIGEN": layer_data_334_PUE_ORIGEN,
            "SLP ORIGEN": layer_data_334_SLP_ORIGEN
        },
        "Subsector 335": {
            "AGS ORIGEN": layer_data_335_AGS_ORIGEN,
            "BC ORIGEN": layer_data_335_BC_ORIGEN,
            "COAH ORIGEN": layer_data_335_COAH_ORIGEN,
            "GTO ORIGEN": layer_data_335_GTO_ORIGEN,
            "JAL ORIGEN": layer_data_335_JAL_ORIGEN,
            "MEX ORIGEN": layer_data_335_MEX_ORIGEN,
            "MOR ORIGEN": layer_data_335_MOR_ORIGEN,
            "NL ORIGEN": layer_data_335_NL_ORIGEN,
            "PUE ORIGEN": layer_data_335_PUE_ORIGEN,
            "SLP ORIGEN": layer_data_335_SLP_ORIGEN
        },
        "Subsector 336": {
            
        },
        "Subsector 511": {
            "AGS ORIGEN": layer_data_511_AGS_ORIGEN,
            "BC ORIGEN": layer_data_511_BC_ORIGEN,
            "COAH ORIGEN": layer_data_511_COAH_ORIGEN,
            "GTO ORIGEN": layer_data_511_GTO_ORIGEN,
            "JAL ORIGEN": layer_data_511_JAL_ORIGEN,
            "MEX ORIGEN": layer_data_511_MEX_ORIGEN,
            "MOL ORIGEN": layer_data_511_MOL_ORIGEN,
            "NL ORIGEN": layer_data_511_NL_ORIGEN,
            "PUE ORIGEN": layer_data_511_PUE_ORIGEN,
            "SLP ORIGEN": layer_data_511_SLP_ORIGEN
        },
        "Subsector 512": {
            "AGS ORIGEN": layer_data_512_AGS_ORIGEN,
            "BC ORIGEN": layer_data_512_BC_ORIGEN,
            "COAH ORIGEN": layer_data_512_COAH_ORIGEN,
            "GTO ORIGEN": layer_data_512_GTO_ORIGEN,
            "JAL ORIGEN": layer_data_512_JAL_ORIGEN,
            "MEX ORIGEN": layer_data_512_MEX_ORIGEN,
            "MOR ORIGEN": layer_data_512_MOR_ORIGEN,
            "NL ORIGEN": layer_data_512_NL_ORIGEN,
            "PUE ORIGEN": layer_data_512_PUE_ORIGEN,
            "SLP ORIGEN": layer_data_512_SLP_ORIGEN
        },
        "Subsector 515": {
            "AGS ORIGEN": layer_data_515_AGS_ORIGEN,
            "BC ORIGEN": layer_data_515_BC_ORIGEN,
            "COAH ORIGEN": layer_data_515_COAH_ORIGEN,
            "GTO ORIGEN": layer_data_515_GTO_ORIGEN,
            "JAL ORIGEN": layer_data_515_JAL_ORIGEN,
            "MEX ORIGEN": layer_data_515_MEX_ORIGEN,
            "MOR ORIGEN": layer_data_515_MOR_ORIGEN,
            "NL ORIGEN": layer_data_515_NL_ORIGEN,
            "PUE ORIGEN": layer_data_515_PUE_ORIGEN,
            "SLP ORIGEN": layer_data_515_SLP_ORIGEN
        },
        "Subsector 517": {
            "AGS ORIGEN": layer_data_517_AGS_ORIGEN,
            "BC ORIGEN": layer_data_517_BC_ORIGEN,
            "COAH ORIGEN": layer_data_517_COAH_ORIGEN,
            "GTO ORIGEN": layer_data_517_GTO_ORIGEN,
            "JAL ORIGEN": layer_data_517_JAL_ORIGEN,
            "MEX ORIGEN": layer_data_517_MEX_ORIGEN,
            "MOR ORIGEN": layer_data_517_MOR_ORIGEN,
            "NL ORIGEN": layer_data_517_NL_ORIGEN,
            "PUE ORIGEN": layer_data_517_PUE_ORIGEN,
            "SLP ORIGEN": layer_data_517_SLP_ORIGEN
        },
        "Subsector 518": {
            "AGS ORIGEN": layer_data_518_AGS_ORIGEN,
            "BC ORIGEN": layer_data_518_BC_ORIGEN,
            "COAH ORIGEN": layer_data_518_COAH_ORIGEN,
            "GTO ORIGEN": layer_data_518_GTO_ORIGEN,
            "JAL ORIGEN": layer_data_518_JAL_ORIGEN,
            "MEX ORIGEN": layer_data_518_MEX_ORIGEN,
            "MOR ORIGEN": layer_data_518_MOR_ORIGEN,
            "NL ORIGEN": layer_data_518_NL_ORIGEN,
            "PUE ORIGEN": layer_data_518_PUE_ORIGEN,
            "SLP ORIGEN": layer_data_518_SLP_ORIGEN
        },
        "Subsector 519": {
            "AGS ORIGEN": layer_data_519_AGS_ORIGEN,
            "BC ORIGEN": layer_data_519_BC_ORIGEN,
            "COAH ORIGEN": layer_data_519_COAH_ORIGEN,
            "GTO ORIGEN": layer_data_519_GTO_ORIGEN,
            "JAL ORIGEN": layer_data_519_JAL_ORIGEN,
            "MEX ORIGEN": layer_data_519_MEX_ORIGEN,
            "MOR ORIGEN": layer_data_519_MOR_ORIGEN,
            "NL ORIGEN": layer_data_519_NL_ORIGEN,
            "PUE ORIGEN": layer_data_519_PUE_ORIGEN,
            "SLP ORIGEN": layer_data_519_SLP_ORIGEN
        },
        "Subsector 541": {
            "AGS ORIGEN": layer_data_541_AGS_ORIGEN,
            "BC ORIGEN": layer_data_541_BC_ORIGEN,
            "COAH ORIGEN": layer_data_541_COAH_ORIGEN,
            "GTO ORIGEN": layer_data_541_GTO_ORIGEN,
            "JAL ORIGEN": layer_data_541_JAL_ORIGEN,
            "MEX ORIGEN": layer_data_541_MEX_ORIGEN,
            "MOR ORIGEN": layer_data_541_MOR_ORIGEN,
            "NL ORIGEN": layer_data_541_NL_ORIGEN,
            "PUE ORIGEN": layer_data_541_PUE_ORIGEN,
            "SLP ORIGEN": layer_data_541_SLP_ORIGEN
        }
        };

        // 5. Añadir el control de capas (agrupado)
        L.control.groupedLayers(baseMaps, groupedOverlays, {
            collapsed: false,
            groupCheckboxes: true 
        }).addTo(map);
        
    </script>

</body>
</html>
